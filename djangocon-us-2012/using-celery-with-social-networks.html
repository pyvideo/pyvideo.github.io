<!DOCTYPE html>
<html lang="en">
<head>
      <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://use.fontawesome.com/2231f865fc.js"></script>
    <link rel="shortcut icon" href="https://pyvideo.org/theme/images/favicon.png">
    <meta name="google-site-verification" content="cHuieLjiIIDAHKKXSPPDsnbLEz9QgVNTi23qy_mOzDU" />

    <title>PyVideo.org &middot; Using Celery with Social Networks</title>

    <link href="https://pyvideo.org/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="PyVideo.org Full Atom Feed" />
    <link href="https://pyvideo.org/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="PyVideo.org Full RSS Feed" />
    <link href="https://pyvideo.org/feeds/event_djangocon-us-2012.atom.xml" type="application/atom+xml" rel="alternate" title="PyVideo.org Event Atom Feed" />
    <link href="https://pyvideo.org/feeds/event_djangocon-us-2012.rss.xml" type="application/rss+xml" rel="alternate" title="PyVideo.org Event RSS Feed" />

    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"
          rel="stylesheet"
          integrity="sha256-7s5uDGW3AHqw6xtJmNNtr+OBRJUlgkNJEo78P4b0yRw= sha512-nNo+yCHEyn0smMxSswnf/OnX6/KwJuZTlNZBjauKhTK0c+zT+q5JOCx0UFhXQ6rJR9jg6Es8gPuD2uZcYDLqSw=="
          crossorigin="anonymous">

    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <link href="/theme/css/ie10-viewport-bug-workaround.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="/theme/css/base.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->


  <meta property="og:site_name" content="PyVideo.org" />
  <meta property="og:title" content="Using Celery with Social Networks" />
  <meta property="og:type" content="video" />
  <meta property="og:url" content="https://pyvideo.org/djangocon-us-2012/using-celery-with-social-networks.html" />
    <meta property="og:image" content="https://i.ytimg.com/vi/z751qhAzMb4/hqdefault.jpg" />
    <meta property="og:image:secure_url" content="https://i.ytimg.com/vi/z751qhAzMb4/hqdefault.jpg" />
    <meta property="og:image:type" content="image/jpeg" />


    <meta name="tags" content="celery" />
    <meta name="tags" content="django" />
</head>

<body>
<a class="github" href="https://github.com/pyvideo/pyvideo/wiki/How-to-Contribute-Media">
    <img style="position: absolute; top: 0; right: 0; border: 0; z-index: 2;" src="/images/contribute_to_me_right_red_aa0000.png" alt="Contribute Media" />
</a>
  <div class="header notice clearfix">
    A thank you to everyone who makes this possible:
    <a href="/pages/thank-you-contributors.html">Read More</a>
  </div>
  <header id="banner" class="header clearfix">
    <nav class="header__nav"><div class="container">
      <ul class="nav">
        <li role="presentation">
          <a href="https://pyvideo.org/index.html"><i class="fa fa-fw fa-home"></i> <span>Start</span></a>
        </li>

        <li role="presentation" class="active">
          <a href="https://pyvideo.org/events.html"><i class="fa fa-fw fa-list-ul"></i> <span>Events</span></a>
        </li>

        <li role="presentation">
          <a href="https://pyvideo.org/tags.html"><i class="fa fa-fw fa-tags"></i> <span>Tags</span></a>
        </li>

        <li role="presentation">
          <a href="https://pyvideo.org/speakers.html"><i class="fa fa-fw fa-users"></i> <span>Speakers</span></a>
        </li>

          <li role="presentation"
>
            <a href="https://pyvideo.org/pages/about.html"><i class="fa fa-fw fa-info"></i> <span>About</span></a>
          </li>
          <li role="presentation"
style="display: none;">
            <a href="https://pyvideo.org/pages/thank-you-contributors.html"><i class="fa fa-fw fa-info"></i> <span>Thank You</span></a>
          </li>
          <li role="presentation"
style="display: none;">
            <a href="https://pyvideo.org/pages/thanks-will-and-sheila.html"><i class="fa fa-fw fa-info"></i> <span></span></a>
          </li>
      </ul>
    </div></nav>
    <div class="container">
      <h3 class="text-muted header__title">
      <a href="https://pyvideo.org/"><img src="/theme/images/logo.png" alt="" style="height:50px"> <span><i>Py</i>Video</span> <strong></strong></a>
      </h3>
      <div class="header__searchbox">
        <form method="GET" action="/search.html">
          <input name="q" type="search" placeholder="Search...">
        </form>
      </div>
    </div>
  </header>
  <div class="container">

<section id="content" class="body">
  <header>
    <h2 class="entry-title">
      <a href="https://pyvideo.org/djangocon-us-2012/using-celery-with-social-networks.html" rel="bookmark"
         title="Permalink to Using Celery with Social Networks">Using Celery with Social Networks
      </a>
    </h2>
 
  </header>

  <footer class="post-info">
    <time class="published" datetime="2012-09-05T00:00:00+00:00">
      <i class="fa fa-calendar"></i> Wed 05 September 2012
    </time>
    <address class="vcard author">
      By
        <a class="url fn" href="https://pyvideo.org/speaker/david-gouldin.html">David Gouldin</a>
    </address>
  </footer><!-- /.post-info -->

  <div class="entry-content">
<ul class="nav nav-tabs" role="tablist">
    <li class="active" role="presentation"><a href="#youtube" aria-controls="youtube" role="tab" data-toggle="tab">
        <i class="fa fa-fw fa-youtube"></i> YouTube
    </a></li>
</ul>

<div class="tab-content">
    <div role="tabpanel" class="tab-pane active" id="youtube">
        <div class="embed-responsive embed-responsive-16by9 videocontainer">
            <iframe class="embed-responsive-item" src="https://www.youtube.com/embed/z751qhAzMb4" title="Video for " frameborder="0" allowfullscreen></iframe>
        </div>
    </div>
</div>    <h3>Summary</h3><p>Many web applications need to interface with social networks, and
celery, a Python distributed task queue library, is a great tool for the
job. However, achieving speed and stability can be difficult. This talk
will cover task organization/distribution, rate limiting, failover, and
other practices to aid in working with social networks at scale.</p>
<h3>Description</h3><p>Twitter conditionally rate limits based on IP address rather than access
token even when one is provided for some of its API calls. Facebook has
at least 10 unique error messages to indicate a bad or expired access
token (that I've found so far). LinkedIn's pagination has an occasional
off-by-one bug resulting in an endless list of 1-user pages. Let's face
it: interfacing with social networks is tricky. Celery helps, but to
provide stable, reliable, and fast social features for your website,
you'll need an arsenal of strategies and tools to get you the rest of
the way there.</p>
<p>By the end of this talk, you'll understand how to set up tasks to
quickly serve users with massive networks by employing intelligent
distribution. You'll be able to design robust processes to handle
inconsistencies or instabilities in 3rd party APIs. And you'll know how
to have confidence that the work you intend to do gets done, regardless
of external rate limits, pagination design, or API call dependency
chains.</p>
<p>This talk is intended for people who have basic familiarity with celery
and would like to learn more about how to take advantage of it for
large, distributed task loads.</p>
<div class="section" id="outline">
<h4>Outline</h4>
<ol class="arabic">
<li><p class="first">Intro</p>
</li>
<li><p class="first">3rd party interfaces are hard</p>
<ul class="simple">
<li>Speed<ul>
<li>Much slower than local data</li>
<li>Users may still expect near-immediate results</li>
</ul>
</li>
<li>Rate limits<ul>
<li>Different rules for every service</li>
<li>Need to handle reactive &amp; proactive as some don't publish
rates</li>
</ul>
</li>
<li>Instability<ul>
<li>Outages (yes, Facebook does go down)</li>
<li>Random failures</li>
</ul>
</li>
<li></li>
</ul>
</li>
<li><p class="first">Why Celery?</p>
<ul class="simple">
<li>Asynchronous</li>
<li>Distributed</li>
<li>Fault tolerant</li>
</ul>
</li>
<li><p class="first">Task Organization</p>
<ol class="arabic simple">
<li>Small, atomic tasks (1 API call per task) B. Minimal message state<ul>
<li>Primitive types only (no model instances!)</li>
<li>Defer as much data access to the task itself as possible</li>
</ul>
</li>
<li>Create Task subclasses for common patterns D. Whenever possible,make tasks idempotent</li>
</ol>
</li>
<li><p class="first">Task Distribution</p>
<ol class="arabic">
<li><p class="first">Managing pagination</p>
<blockquote>
<ul class="simple">
<li>For a known set size<ul>
<li>Where limit/offset is supported, launch all page tasks
simlutaneously</li>
<li>Otherwise, 1 page launches the next as soon as the next
cursor is obtained</li>
</ul>
</li>
<li>For an unknown set size<ul>
<li>Set max simultaneous pages</li>
<li>Task is terminal if blank, otherwise launches page w/
offset + max pages</li>
</ul>
</li>
<li>Setting page size is an art, not a science<ul>
<li>Minimize the number of api calls when possible</li>
<li>Avoid long-running tasks by setting a timeout ceiling</li>
<li>Avoid the temptation to pass API data to dependent tasks</li>
</ul>
</li>
<li></li>
</ul>
</blockquote>
</li>
<li><p class="first">Tracking task dependencies (&quot;Done?&quot; is difficult for distributed systems)</p>
<blockquote>
<ul class="simple">
<li>Use an external backend to store a dependency tree</li>
<li>Subclass ResultSet to evaluate the task state of the tree</li>
<li>Requires ignore_result=False</li>
</ul>
</blockquote>
</li>
</ol>
</li>
<li><p class="first">Rate Limiting</p>
<ol class="arabic simple">
<li>Problems<ul>
<li>Celery's rate limiting doesn't do what you think it does</li>
<li>3rd party rate limits depend on many factors</li>
</ul>
</li>
<li>Solution<ul>
<li>For services with known rate limits:<ul>
<li>Use an external backend to store rate limit counters</li>
<li>Increment counters based on rate limit factors per api call</li>
</ul>
</li>
<li>For services with unknown rate limits:<ul>
<li>Use an external backend to store rate limit backoff counters</li>
<li>Ramp up / ratchet down call rate by power law as api callsfail/succeed</li>
</ul>
</li>
</ul>
</li>
<li></li>
</ol>
</li>
<li><p class="first">Failover</p>
</li>
<li><p class="first">Problems</p>
<ul class="simple">
<li>Celery's countdown doesn't do what you think it does</li>
<li>3rd parties can fail in lots of &quot;interesting&quot; ways</li>
</ul>
</li>
<li><p class="first">Solution</p>
<ul class="simple">
<li>Implement native RabbitMQ alternative to countdown</li>
<li>Create task base classes per social network to handle error
conditions</li>
</ul>
</li>
<li><p class="first">Multiple queues</p>
<ol class="arabic simple">
<li>Better control over task priority management &amp; resource distribution</li>
<li>Not all social accounts are created equal (handling whales &amp; spikes)</li>
<li>When you can't stream updates, use a trickle queue</li>
</ol>
</li>
<li><p class="first">Celerybeat considered harmful</p>
<ol class="arabic simple">
<li>Periodic task persistence gets out of sync with code</li>
<li>Just 1 more process to manage</li>
<li>Cron: it's just. not. that. hard.</li>
</ol>
</li>
<li><p class="first">Debugging</p>
<ol class="arabic simple">
<li>Don't use &quot;always eager&quot;</li>
<li>Logging, logging, logging</li>
<li>Unit tests are good, but integration tests save lives</li>
</ol>
</li>
<li><p class="first">Gotchas</p>
<blockquote>
<ol class="arabic simple">
<li>Open socket prevents Celery soft timeout</li>
<li>Celery soft timeout doesn't retry the task</li>
<li>If result state is not known, Celery reports &quot;PENDING&quot;</li>
</ol>
</blockquote>
</li>
</ol>
</div>

  </div><!-- /.entry-content -->

<div class="details-content">
  <h3>Details</h3>
  <ul>
      <li>
        Event:
        <a href="https://pyvideo.org/events/djangocon-us-2012.html">DjangoCon US 2012</a>
      </li>
        <li>Language: English</li>
        <li>
            Media URL: <a href="https://www.youtube.com/watch?v=z751qhAzMb4" rel="external">YouTube</a>        </li>
        <li>
          Tags:
<a href="https://pyvideo.org/tag/celery/">celery</a>, <a href="https://pyvideo.org/tag/django/">django</a>        </li>

  </ul>
</div>
    <a href="https://github.com/pyvideo/data/blob/master/djangocon-2012/videos/using-celery-with-social-networks.json">
      <i class="fa fa-pencil-square-o"></i> Improve this page
    </a>

</section>

    <footer class="footer">
      <p>
        &copy;
        <a href="https://github.com/pyvideo/pyvideo/blob/master/LICENSE">PyVideo.org</a> |
        <a href="https://github.com/pyvideo/data/blob/master/LICENSE">pyvideo/data</a>
      </p>
    </footer>

      <script src="https://code.jquery.com/jquery-2.2.0.min.js"></script>
      <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha256-KXn5puMvxCw+dAYznun+drMdG1IFl3agK0p/pqT9KAo= sha512-2e8qq0ETcfWRI4HJBzQiA3UoyFk6tbNyG+qSaIBZLyW9Xf3sWZHN/lxe9fTh1U45DpPf07yj94KsUHHWe4Yk1A==" crossorigin="anonymous"></script>
      <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
      <script src="/theme/js/ie10-viewport-bug-workaround.js"></script>
      <script src="/theme/js/thumb.js"></script>
      <script src="/theme/js/language.js"></script>
    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-72949800-2']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = 'https://ssl.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
  </div>
</body>
</html>