<!DOCTYPE html>
<html lang="en">
<head>
      <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://use.fontawesome.com/2231f865fc.js"></script>
    <link rel="shortcut icon" href="https://pyvideo.org/theme/images/favicon.png">
    <meta name="google-site-verification" content="cHuieLjiIIDAHKKXSPPDsnbLEz9QgVNTi23qy_mOzDU" />

    <title>PyVideo.org &middot; Why large Django projects need a data (prefetching) layer</title>

    <link href="https://pyvideo.org/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="PyVideo.org Full Atom Feed" />
    <link href="https://pyvideo.org/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="PyVideo.org Full RSS Feed" />
    <link href="https://pyvideo.org/feeds/event_djangocon-us-2022.atom.xml" type="application/atom+xml" rel="alternate" title="PyVideo.org Event Atom Feed" />
    <link href="https://pyvideo.org/feeds/event_djangocon-us-2022.rss.xml" type="application/rss+xml" rel="alternate" title="PyVideo.org Event RSS Feed" />

    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"
          rel="stylesheet"
          integrity="sha256-7s5uDGW3AHqw6xtJmNNtr+OBRJUlgkNJEo78P4b0yRw= sha512-nNo+yCHEyn0smMxSswnf/OnX6/KwJuZTlNZBjauKhTK0c+zT+q5JOCx0UFhXQ6rJR9jg6Es8gPuD2uZcYDLqSw=="
          crossorigin="anonymous">

    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <link href="/theme/css/ie10-viewport-bug-workaround.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="/theme/css/base.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->


  <meta property="og:site_name" content="PyVideo.org" />
  <meta property="og:title" content="Why large Django projects need a data (prefetching) layer" />
  <meta property="og:type" content="video" />
  <meta property="og:url" content="https://pyvideo.org/djangocon-us-2022/why-large-django-projects-need-a-data-prefetching-layer.html" />
    <meta property="og:image" content="https://i.ytimg.com/vi/arxSbzxXo7s/maxresdefault.jpg" />
    <meta property="og:image:secure_url" content="https://i.ytimg.com/vi/arxSbzxXo7s/maxresdefault.jpg" />
    <meta property="og:image:type" content="image/jpeg" />


</head>

<body>
<a class="github" href="https://github.com/pyvideo/pyvideo/wiki/How-to-Contribute-Media">
    <img style="position: absolute; top: 0; right: 0; border: 0; z-index: 2;" src="/images/contribute_to_me_right_red_aa0000.png" alt="Contribute Media" />
</a>
  <div class="header notice clearfix">
    A thank you to everyone who makes this possible:
    <a href="/pages/thank-you-contributors.html">Read More</a>
  </div>
  <header id="banner" class="header clearfix">
    <nav class="header__nav"><div class="container">
      <ul class="nav">
        <li role="presentation">
          <a href="https://pyvideo.org/index.html"><i class="fa fa-fw fa-home"></i> <span>Start</span></a>
        </li>

        <li role="presentation" class="active">
          <a href="https://pyvideo.org/events.html"><i class="fa fa-fw fa-list-ul"></i> <span>Events</span></a>
        </li>

        <li role="presentation">
          <a href="https://pyvideo.org/tags.html"><i class="fa fa-fw fa-tags"></i> <span>Tags</span></a>
        </li>

        <li role="presentation">
          <a href="https://pyvideo.org/speakers.html"><i class="fa fa-fw fa-users"></i> <span>Speakers</span></a>
        </li>

          <li role="presentation"
>
            <a href="https://pyvideo.org/pages/about.html"><i class="fa fa-fw fa-info"></i> <span>About</span></a>
          </li>
          <li role="presentation"
style="display: none;">
            <a href="https://pyvideo.org/pages/thank-you-contributors.html"><i class="fa fa-fw fa-info"></i> <span>Thank You</span></a>
          </li>
          <li role="presentation"
style="display: none;">
            <a href="https://pyvideo.org/pages/thanks-will-and-sheila.html"><i class="fa fa-fw fa-info"></i> <span></span></a>
          </li>
      </ul>
    </div></nav>
    <div class="container">
      <h3 class="text-muted header__title">
      <a href="https://pyvideo.org/"><img src="/theme/images/logo.png" alt="" style="height:50px"> <span><i>Py</i>Video</span> <strong></strong></a>
      </h3>
      <div class="header__searchbox">
        <form method="GET" action="/search.html">
          <input name="q" type="search" placeholder="Type / to search...">
        </form>
      </div>
    </div>
  </header>
  <div class="container">

<section id="content" class="body">
  <header>
    <h2 class="entry-title">
      <a href="https://pyvideo.org/djangocon-us-2022/why-large-django-projects-need-a-data-prefetching-layer.html" rel="bookmark"
         title="Permalink to Why large Django projects need a data (prefetching) layer">Why large Django projects need a data (prefetching) layer
      </a>
    </h2>
 
  </header>

  <footer class="post-info">
    <time class="published" datetime="2022-10-19T00:00:00+00:00">
      <i class="fa fa-calendar"></i> Wed 19 October 2022
    </time>
    <address class="vcard author">
      By
        <a class="url fn" href="https://pyvideo.org/speaker/flavio-juvenal.html">Flávio Juvenal</a>
    </address>
  </footer><!-- /.post-info -->

  <div class="entry-content">
<ul class="nav nav-tabs" role="tablist">
    <li class="active" role="presentation"><a href="#youtube" aria-controls="youtube" role="tab" data-toggle="tab">
        <i class="fa fa-fw fa-youtube"></i> YouTube
    </a></li>
</ul>

<div class="tab-content">
    <div role="tabpanel" class="tab-pane active" id="youtube">
        <div class="embed-responsive embed-responsive-16by9 videocontainer">
            <iframe class="embed-responsive-item" src="https://www.youtube.com/embed/arxSbzxXo7s" title="Video for " frameborder="0" allowfullscreen></iframe>
        </div>
    </div>
</div>    <h3>Description</h3><p>The main building blocks of Django REST Framework projects, i.e. Views, Serializers, Managers, and Querysets allow developers to implement complex APIs with very little code repetition while reusing built-ins for essential API features. Developers feel guided by DRF to architect the project in a “Don’t Repeat Yourself” way by using inheritance, nesting, annotations, and model / app-based separation of concerns. They can group code in viewsets, inherit from base classes, reuse the same serializer across views, nest serializers into others, compute fields dynamically with ORM annotations, select or prefetch relations for performance, organize custom behavior with managers and querysets, and much more. All this DRYness is great because it integrates well with common web API concerns like permissions, pagination, filters, etc.</p>
<p>Based on our multi-year experience in building and maintaining several large Django projects, while using those built-in concepts really yields a DRY code, the overuse also results in a codebase full of complicated bugs and performance issues, especially related to ORM usage. View, serializer, and model methods are often heavily coupled to querysets’ annotations and prefeches, but those methods are spread across the codebase. Django’s default queryset laziness, together with its heavy usage of inheritance and nesting is the perfect recipe for a codebase where N+1 issues and heavy unnecessary queries can happen in any line of code after some less careful change.</p>
<p>For example, to prevent N+1 issues, if a serializer method field uses a filtered relationship, you must ensure this relationship is prefetched in all querysets related to that serializer. But this serializer can be nested into others, so you must now be careful to change all queryset references in seemingly unrelated views. Other sorts of “change amplification” situations also happen on large DRF codebases with heavy ORM usage. Requiring developers to be careful while navigating through lots of files to perform changes isn’t reasonable. Maybe being DRY is leading to the wrong abstraction?</p>
<p>It’s possible to design a better architecture that’s optimized both for enabling changes and avoiding performance regressions. With a new custom data prefetching layer that keeps compatibility with serializers and views, we can respect DRY while keeping performance and maintainability. That’s what we’ve been doing in our Django projects, and we will share our learnings in this talk. Hopefully, that applies to other maintainers of complex DRF projects.</p>
<p>Here's the planned outline:
- Django REST Framework is DRY: the good side
- Trade-offs of DRY in DRF: when reusing serializers leads to Change Amplification on prefetches and annotations
- How view querysets and serializers are coupled
- How vanilla Django suffers from the same issues
- Incomplete solutions that weren't enough for us
- Solving with a data prefetching layer: [django-virtual-models](<a class="reference external" href="https://github.com/vintasoftware/django-virtual-models/">https://github.com/vintasoftware/django-virtual-models/</a>)
- Warn programmers during dev time about missing prefetches and annotations for each serializer
- Automatically run necessary prefetches and annotations
- Automatically prevent unnecessary prefetches and annotations
- Keep serializer nesting support
- Keep <cite>SerializerMethodField</cite> support
- Other solutions, including [django-readers](<a class="reference external" href="https://github.com/dabapps/django-readers/">https://github.com/dabapps/django-readers/</a>)</p>

  </div><!-- /.entry-content -->

<div class="details-content">
  <h3>Details</h3>
  <ul>
      <li>
        Event:
        <a href="https://pyvideo.org/events/djangocon-us-2022.html">DjangoCon US 2022</a>
      </li>
        <li>Language: English</li>
        <li>
            Media URL: <a href="https://www.youtube.com/watch?v=arxSbzxXo7s" rel="external">YouTube</a>        </li>
        <li>
          Related URLs:
          <ul class="related-urls">
<li><a href="https://2022.djangocon.us">
Conference Website                </a></li>          </ul>
        </li>

  </ul>
</div>
    <a href="https://github.com/pyvideo/data/blob/main/djangocon-us-2022/videos/why-large-django-projects-need-a-data-prefetching-layer.json">
      <i class="fa fa-pencil-square-o"></i> Improve this page
    </a>

</section>

    <footer class="footer">
      <p>
        &copy;
        <a href="https://github.com/pyvideo/pyvideo/blob/main/LICENSE">PyVideo.org</a> |
        <a href="https://github.com/pyvideo/data/blob/main/LICENSE">pyvideo/data</a>
      </p>
    </footer>

      <script src="https://code.jquery.com/jquery-2.2.0.min.js"></script>
      <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha256-KXn5puMvxCw+dAYznun+drMdG1IFl3agK0p/pqT9KAo= sha512-2e8qq0ETcfWRI4HJBzQiA3UoyFk6tbNyG+qSaIBZLyW9Xf3sWZHN/lxe9fTh1U45DpPf07yj94KsUHHWe4Yk1A==" crossorigin="anonymous"></script>
      <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
      <script src="/theme/js/ie10-viewport-bug-workaround.js"></script>
      <script src="/theme/js/thumb.js"></script>
      <script src="/theme/js/language.js"></script>
      <script src="/theme/js/searchbar.js"></script>
    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-72949800-2']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = 'https://ssl.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
  </div>
</body>
</html>